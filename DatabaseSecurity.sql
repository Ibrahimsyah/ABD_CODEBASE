--IMPLEMENTATION OF ROLE BASED CONTROL ACCESS IN DB2
--MEET THE ACTORS:
--1. MAHASISWA	: Can only see his/her own JADWAL and MAHASISWA
--2. DOSEN      : Can only see his own JADWAL
--3. KAPRODI    : Can see anything


--Here We Go.
--Generating Table
CREATE TABLE PRODI(
ID_PRODI smallint NOT NULL PRIMARY KEY,
PRODI VARCHAR(50));

CREATE TABLE MATKUL(
ID_MATKUL smallint NOT NULL PRIMARY KEY,
MATKUL VARCHAR(40));

CREATE TABLE MAHASISWA(
NIM VARCHAR(20) NOT NULL PRIMARY KEY,
NAMA VARCHAR(60),
ID_PRODI smallint REFERENCES PRODI);

CREATE TABLE DOSEN(
NIP VARCHAR(20) NOT NULL PRIMARY KEY,
NAMA VARCHAR(60),
ID_PRODI smallint REFERENCES PRODI);

CREATE TABLE JADWAL(
NIM VARCHAR(20) REFERENCES MAHASISWA NOT NULL,
ID_MATKUL smallint REFERENCES MATKUL NOT NULL,
NIP VARCHAR(20) REFERENCES DOSEN,
PRIMARY KEY(NIM, ID_MATKUL));

--Filling Table
INSERT INTO PRODI
VALUES (1, 'Sistem Informasi'),
       (2, 'Teknologi Informasi');

INSERT INTO DOSEN
VALUES (123, 'dosen1', 1),
       (124, 'dosen2', 1),
       (125, 'dosen3', 2);
       
INSERT INTO MATKUL
VALUES (1, 'ABD'),
       (2, 'DBD'),
       (3, 'Pemweb'),
       (4, 'Pemdas');
       
INSERT INTO MAHASISWA
VALUES (123, 'Mhs1', 1),
       (133, 'Mhs2', 1),
       (143, 'Mhs3', 2);
       
INSERT INTO JADWAL
VALUES (123, 1, 123),
       (143, 2, 123),
       (143, 3, 123),
       (123, 3, 124),
       (143, 1, 125);

--Create Roles
CREATE ROLE DOSEN;
CREATE ROLE MAHASISWA;

--Assign Role to Users
GRANT ROLE DOSEN TO USER DOSEN1;
GRANT ROLE MAHASISWA TO USER MAHASISWA1;
GRANT ROLE KAPRODI TO USER KAPRODI1;

--Grant Roles
GRANT
SELECT ON TABLE MAHASISWA TO ROLE MAHASISWA,
                                  KAPRODI,
                                  DBADM;
GRANT
SELECT ON TABLE DOSEN TO ROLE DOSEN,
                              KAPRODI;
GRANT
SELECT ON TABLE JADWAL TO ROLE DOSEN,
                               MAHASISWA,
                               KAPRODI;

--Permission for DOSEN
CREATE OR REPLACE PERMISSION P1 ON DOSEN
FOR ROWS
WHERE (VERIFY_ROLE_FOR_USER(SESSION_USER, 'DOSEN') = 1
       AND LOWER(DOSEN.NAMA) = LOWER(SESSION_USER))
  OR (VERIFY_ROLE_FOR_USER(SESSION_USER, 'KAPRODI') = 1) ENFORCED
  FOR ALL ACCESS ENABLE;
ALTER TABLE DOSEN ACTIVATE ROW ACCESS CONTROL;

--Permission for JADWAL
CREATE OR REPLACE PERMISSION P2 ON JADWAL
FOR ROWS
WHERE (VERIFY_ROLE_FOR_USER(SESSION_USER, 'DOSEN') = 1
       AND JADWAL.NIP =
         (SELECT NIP
          FROM DB2INST1.DOSEN D
          WHERE LOWER(D.NAMA) = LOWER(SESSION_USER)))
  OR (VERIFY_ROLE_FOR_USER(SESSION_USER, 'MAHASISWA') = 1
      AND JADWAL.NIM =
        (SELECT NIM
         FROM DB2INST1.MAHASISWA M
         WHERE LOWER(M.NAMA) = LOWER(SESSION_USER)))
  OR (VERIFY_ROLE_FOR_USER(SESSION_USER, 'KAPRODI') = 1) ENFORCED
  FOR ALL ACCESS ENABLE;
ALTER TABLE JADWAL ACTIVATE ROW ACCESS CONTROL;

--Permission for MAHASISWA
CREATE PERMISSION P3 ON MAHASISWA
FOR ROWS
WHERE (VERIFY_ROLE_FOR_USER(SESSION_USER, 'MAHASISWA') = 1
       AND LOWER(MAHASISWA.NAMA) = LOWER(SESSION_USER))
  OR VERIFY_ROLE_FOR_USER(SESSION_USER, 'KAPRODI') = 1 ENFORCED
  FOR ALL ACCESS ENABLE;
ALTER TABLE MAHASISWA ACTIVATE ROW ACCESS CONTROL;
